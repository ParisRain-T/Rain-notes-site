---
title: 日志规范：可观测、可定位、可复盘
draft: false
stage: budding
---

# 日志规范（让你 1 分钟定位故障）

做 P0/P1 时，“会不会排障”会决定你能不能持续推进。日志的目标不是“多打印”，而是做到：

- **同一条命令/同一段数据链路**，端侧/网关/后端的日志能串起来
- 出问题时能在 **1 分钟内定位到是哪一层**（MCU / 网关 / MQTT / 后端 / DB）

> 协议与字段语义以 [[P0_SPEC_v1]] 为准（尤其是 `device_id`、`cmd_id`、`telemetry_seq`）。

## 1）必须统一的 3 个关联键（全链路一致）

- `device_id`：设备标识（topic、DB、API、日志都用它）
- `cmd_id`：命令幂等键（所有命令相关日志必须带）
- `telemetry_seq`：遥测序号（遥测相关日志必须带）

只要你做到“日志里永远有这 3 个键（按场景）”，排障效率会提升一个数量级。

## 2）日志等级（最小可用）

- `DEBUG`：开发期打开，生产/演示默认关闭（避免刷屏）
- `INFO`：状态变化、链路关键节点（默认开启）
- `WARN`：可恢复异常（重试、丢帧、重连）
- `ERROR`：不可恢复异常（导致功能失败/状态失败）

## 3）固件（MCU）日志规则

### 3.1 不要把人类可读日志混进协议 UART（推荐）

优先级（从好到差）：

1. **单独的调试串口**输出文本日志（最好）
2. 用协议里的 `LOG` 帧输出日志（能被网关解析/上云，可观测更强）
3. 临时 `printf` 混在一起（最不推荐，容易破坏解析）

### 3.2 固件日志最小字段

- `uptime_ms`（必带）
- `telemetry_seq`（遥测发送/解析相关）
- `cmd_id`（命令接收/执行/ACK 相关）
- `err_code`（失败原因，来自 [[P0_SPEC_v1]] 的错误码表）

### 3.3 固件日志模板（文本版示例）

```text
INFO mcu device=f411-001 uptime_ms=123456 telemetry_seq=42 event=telemetry_sent len=18
INFO mcu device=f411-001 uptime_ms=124000 cmd_id=1001 event=cmd_received cmd=set_led arg0=1
INFO mcu device=f411-001 uptime_ms=124010 cmd_id=1001 event=cmd_done status=OK
WARN mcu device=f411-001 uptime_ms=124020 event=bad_frame err_code=0x0001
```

## 4）网关（PC/树莓派）日志规则

网关是排障中枢：它既看到串口，又看到 MQTT。

### 4.1 网关必须打印的关键节点

- 串口连接/断开/重连（带端口名）
- 每次成功解析一帧（至少采样打印，不要每帧都刷屏）
- 每次 CRC/LEN 错误计数
- MQTT 连接/断开/重连（带 retry/backoff）
- `cmd` 收到→串口下发→收到 `ACK`→发布 `ack` 的完整链路（必须带 `cmd_id`）

### 4.2 网关日志建议“结构化”（推荐）

网关建议用 JSON 日志（后续做统计/可视化更顺），最小字段：

- `ts_ms`、`level`、`component=gateway`
- `device_id`、`cmd_id`/`telemetry_seq`
- `event`（固定枚举）
- `detail`（可选）

事件枚举建议：

- `serial_connected` / `serial_disconnected` / `serial_reconnected`
- `frame_parsed` / `frame_crc_fail` / `frame_len_fail`
- `mqtt_connected` / `mqtt_disconnected` / `mqtt_reconnected`
- `cmd_rx_mqtt` / `cmd_tx_serial` / `ack_rx_serial` / `ack_tx_mqtt`

## 5）后端（FastAPI）日志规则

后端需要做到“API 视角 + 数据链路视角”都可观测。

### 5.1 后端必须带的字段

- `device_id`
- `cmd_id`（命令相关）
- `request_id`（每次 HTTP 请求生成一个，便于排 API 问题）
- `db_op`（insert/update/select 的关键结果：成功/失败/耗时）

### 5.2 后端关键事件（必须）

- 收到 telemetry 并入库成功（可采样打印）
- 下发命令：创建记录→发布 MQTT→更新状态
- 收到 ack：更新状态→记录 `ack_status/err_code`

## 6）如何把日志变成“硬指标”

建议每月在 `docs/reviews/YYYY-MM.md` 统计（手工也行）：

- 命令成功率（成功/总数）
- 平均 ACK RTT（发布 cmd 到收到 ack）
- 平均定位时间（从发现失败到定位到层级）
- 重连次数（串口、MQTT）

> 目标不是做大数据平台，而是让你每次复盘都有“数字证据”。
