---
title: 错误码与故障字典：现象→定位→修复
draft: false
stage: budding
---

# 错误码与故障字典（把“偶发”变成“可复现”）

这页的目标是：当你遇到问题时，不要靠猜，而是按固定流程把问题定位到一层，并留下可复用的复盘。

> 协议错误码以 [[P0_SPEC_v1]] 为准；日志字段建议按 [[日志规范]] 统一。

## 1）错误码（固件/网关/后端共同语言）

你可以从最小集合开始（先保证“同一错误码三端含义一致”）：

- `0x0001`：BAD_CRC（CRC 校验失败）
- `0x0002`：BAD_LEN（长度非法）
- `0x0003`：UNKNOWN_TYPE（未知 TYPE）
- `0x0101`：UNKNOWN_CMD（未知命令）
- `0x0102`：ARG_OUT_OF_RANGE（参数越界）
- `0x0201`：SENSOR_READ_FAIL（传感器读取失败）
- `0x0202`：I2C_BUS_ERROR（I2C 总线错误）

> 建议：无论在哪一层检测到错误，都要把 `err_code` 写进日志与 ACK（能上云更好）。

## 2）故障字典（常见 12 类，按优先级）

每一条都按固定结构写：**现象 → 最可能原因 → 复现/定位步骤 → 修复动作 → 证据留存**。

### 2.1 串口没输出 / 输出乱码

- 现象：看不到日志/帧；或字符乱码、断行
- 最可能原因：波特率不一致、串口口选错、时钟配置错、线材/供电不稳
- 定位步骤
  1. 确认端口是否正确（macOS 设备名经常变）
  2. 固件改成“只输出固定字符串”（排除协议/解析干扰）
  3. 用低波特率验证（例如 9600）再升回 115200
- 修复动作：统一波特率；检查时钟；换线；确保共地
- 证据留存：录屏（终端串口输出）+ 提交 `docs/debug_serial.md`

### 2.2 CRC 错误率高（>0）

- 现象：`BAD_CRC` 频繁；偶发命令失败/丢帧
- 最可能原因：CRC 覆盖范围不一致、字节序错误、LEN 计算错、帧边界丢失
- 定位步骤
  1. 在 PC 上做“纯软件 loopback”单测：encode→decode 必须 100% 通过
  2. 抓原始 bytes（十六进制 dump），对照 [[P0_SPEC_v1]] 检查字段
  3. 注入坏帧（1%）验证 resync 是否生效（不能卡死）
- 修复动作：统一 CRC 参数与覆盖范围；修正 LEN 与 parser 状态机
- 证据留存：保存一段原始串口流到 `logs/serial_raw_*.bin`

### 2.3 parser 卡死 / 一旦错帧后再也解析不出来

- 现象：一开始能解析，出现一次异常后一直“无帧”
- 最可能原因：状态机不 forward progress；错误处理时没丢弃字节；SOF 搜索逻辑有 bug
- 定位步骤：用小脚本注入“截断帧/坏 CRC/伪 SOF”，观察 parser 是否能恢复
- 修复动作：按 [[P0_SPEC_v1]] 的 resync 规则实现“至少消耗 1 字节”
- 证据留存：写单测覆盖这类输入（防回归）

### 2.4 命令偶发超时（ACK TIMEOUT）

- 现象：少量命令超时或 RTT 很高；重试后又成功
- 最可能原因：网关线程阻塞、串口读写同线程、等待 ACK 的队列设计有问题
- 定位步骤
  1. 在网关日志中检查 `cmd_rx_mqtt → cmd_tx_serial → ack_rx_serial → ack_tx_mqtt` 的耗时分布
  2. 把网关改成：串口读线程 + 命令队列（避免互相阻塞）
- 修复动作：线程化/异步化；减少串口写阻塞；加超时/重试与统计
- 证据留存：输出 RTT 统计（平均/95p/最大）

### 2.5 收到 cmd 但设备不执行

- 现象：MQTT 能看到 cmd；网关也打印“已下发”；但 MCU 没响应/没 ACK
- 最可能原因：串口写失败、MCU 命令解析未覆盖、`cmd_id`/payload 解释不一致
- 定位步骤：在 MCU 侧打印 `cmd_received`（带 `cmd_id`）并确认参数解析正确
- 修复动作：对照 [[P0_SPEC_v1]] 修正 payload 结构；补齐 UNKNOWN_CMD/ARG_OUT_OF_RANGE 的 ACK
- 证据留存：同一条 `cmd_id` 的端/边/云日志截取

### 2.6 MQTT 收不到 telemetry

- 现象：串口帧正常，但 `mosquitto_sub` 看不到数据
- 最可能原因：网关没发布、连错 broker、topic 命名不一致、权限/认证问题（后期）
- 定位步骤：先让网关在 publish 前打印 topic 与 payload；再本机订阅 `devices/#`
- 修复动作：对齐 topic（按 [[P0_SPEC_v1]]）；确认 broker 地址
- 证据留存：保留 `mosquitto_sub` 输出与网关日志

### 2.7 后端没入库 / 数据不增长

- 现象：MQTT 有消息，但 DB 行数不变；API 查不到数据
- 最可能原因：订阅没成功、DB 连接串错 host、事务没提交、schema 不一致
- 定位步骤：`docker compose logs backend -f` 看是否收到消息与 insert 成功；后端加 insert 计数日志
- 修复动作：修正 broker host（容器内不是 localhost）；补齐异常处理与重连
- 证据留存：backend 日志 + DB 行数截图

### 2.8 API 能访问但返回空

- 现象：`/health` 正常，`/devices` 为空
- 最可能原因：查询条件/时间范围错误；timestamp 单位混用（秒 vs 毫秒）
- 定位步骤：打印 from/to 的实际值；DB 直接查一条最新行对比
- 修复动作：统一 `ts_ms`；在 API 层做参数校验与默认值
- 证据留存：curl 请求与响应、对应 SQL 查询

### 2.9 `docker compose up` 失败

- 现象：容器起不来/端口冲突/依赖未 ready
- 最可能原因：端口被占用、环境变量缺失、健康检查/依赖顺序
- 定位步骤：看 `docker compose ps` + `docker compose logs <service>`
- 修复动作：换端口/补 env/加健康检查与 retry

### 2.10 Pi 上跑不稳（部署后掉线）

- 现象：长跑一段时间后 gateway/backend 掉线；性能抖动
- 最可能原因：电源不足、过热降频、SD 卡 I/O 慢
- 定位步骤：先确认电源与散热；看系统日志；降低采样频率验证是否缓解
- 修复动作：用官方电源与散热；必要时上 NVMe；加 watchdog

### 2.11 固件偶发死机

- 现象：运行一段时间后无输出，需要复位
- 最可能原因：栈溢出、ISR 里做太多、内存越界、阻塞调用
- 定位步骤：打开 HardFault 捕获；缩小变量（先关传感器/先关命令）定位触发条件
- 修复动作：减少 ISR 工作量；增加边界检查；把解析放主循环

### 2.12 “能跑但讲不清楚”（面试失败常见）

- 现象：系统能跑，但被问到 QoS/幂等/重试/排障就卡
- 定位步骤：按 [[作品集材料包]] 的追问清单做一次自问自答
- 修复动作：把答案写进 `docs/architecture.md` 与英文 README，并录 2–4 分钟 demo

---

## 3）复盘模板（遇到一次就写一次）

建议每次故障复盘用同一套模板（写到 `docs/reviews/`）：

1. 现象（截图/日志/脚本输出）
2. 影响（哪个 Gate/哪个指标失败）
3. 根因（root cause）
4. 修复（代码/配置/流程）
5. 防回归（新增了哪个测试/脚本/监控）
