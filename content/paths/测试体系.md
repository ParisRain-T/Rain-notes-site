---
title: 测试体系：从脚本验收到故障注入
draft: false
stage: budding
---

# 测试体系（为 P0/P1 持续迭代服务）

你现在已经有“Gate + 3 个验收脚本”的思路，但要长期迭代不变脆，需要把测试分层做成体系：**单测 → 合同测试 → 端到端脚本 → 故障注入**。

> P0 的协议/Topic/API 以 [[P0_SPEC_v1]] 为准；测试也要围绕它来写，避免“测试测的不是同一件事”。
> 时序/并发/阻塞约束看：[[实时规则]]；排障与可观测看：[[日志规范]]、[[错误码与故障字典]]；版本过关线看：[[DoD清单]]。

## 1）测试金字塔（四层）

### 1.1 协议单测（Unit Tests）

目标：任何人改了协议实现，第一时间在本机就能发现“编解码/CRC/parser”被改坏了。

- 覆盖范围（最小集合）
  - frame encode/decode（含边界长度）
  - CRC16 与至少 3 组黄金向量（固定输入→固定输出）
  - parser 状态机：坏帧、截断帧、SOF 嵌套、重同步
  - ring buffer：满/空/回绕/随机压测
- 建议做法
  - C：优先做“主机侧可运行单测”（用 clang/gcc 编译跑），比在板子上测快 10 倍
  - Python：pytest 覆盖 `serial_protocol.py` / `gateway` 解析逻辑

### 1.2 合同测试（Contract Tests）

目标：保证“消息长相”稳定，避免三端演进导致字段漂移。

- MQTT JSON 合同
  - telemetry/cmd/ack 的字段名、类型、必选字段
  - 新增字段只能追加，不能改名/改语义
- API 合同
  - 关键接口 response schema（Pydantic model 就是合同）
  - 典型错误响应（400/404/500）也要有固定结构

### 1.3 端到端验收脚本（E2E Scripts）

目标：用最少脚本覆盖“链路是否真的跑通”。

建议至少 3 个脚本（与你 Gate 对齐）：

1. 串口协议验收：发 CMD 1000 次，ACK 成功率 ≥ 99%
2. MQTT 往返验收：API/脚本发 cmd → 等 ack，统计成功率与 RTT
3. API 烟雾测试：`/health`、设备列表、遥测查询、命令状态查询

输出必须可用于“证据留存”：PASS/FAIL + 关键统计 + 日志路径。

### 1.4 故障注入（Fault Injection）

目标：把“偶发问题”变成“可复现问题”，并把恢复能力做成可验证指标。

最小故障注入清单（P0 必做）：

- 串口拔插：网关能自动重连并恢复遥测/命令
- 断网 60 秒：MQTT 连接恢复，系统继续入库
- 重启 broker：网关/后端能重连并恢复
- 重启后端：不影响设备侧持续上报；后端恢复后继续入库

建议输出一份 runbook（`docs/runbook.md`）：现象→定位→恢复步骤。

---

## 2）什么叫“测试过关”（长期可跟踪指标）

你需要的不是“这周跑通了”，而是可持续上升的硬指标：

- **稳定性**：连续运行时长 1h → 8h → 24h → 48h
- **可靠性**：命令成功率 ≥95% → ≥98% → ≥99%
- **可观测**：平均定位时间 5min → 2min → 1min
- **可复现**：新机器复现耗时 30min → 15min → 10min

每月把数据写进 `docs/reviews/YYYY-MM.md`（一页表格即可）。

---

## 3）建议的目录与证据留存

你可以按习惯调整，但要保证“脚本/日志/证据”有固定落点：

- `scripts/`：端到端验收脚本（E2E）
- `tests/`：协议单测、合同测试
- `logs/`：串口原始流、MQTT 报文、后端日志（按日期归档）
- `docs/reviews/`：每周/每月复盘与指标
